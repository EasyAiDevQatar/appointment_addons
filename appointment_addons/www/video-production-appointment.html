{% extends "templates/web.html" %}

{% block title %}{{ _("Video Production Appointment") }}{% endblock %}

{% block page_content %}
<style>
	.appointment-container {
		max-width: 900px;
		margin: 40px auto;
		padding: 30px;
		background: #fff;
		border-radius: 8px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.progress-bar-container {
		display: flex;
		justify-content: space-between;
		margin-bottom: 40px;
		position: relative;
	}

	.progress-bar-container::before {
		content: '';
		position: absolute;
		top: 20px;
		left: 0;
		right: 0;
		height: 2px;
		background: #e0e0e0;
		z-index: 0;
	}

	.progress-step {
		flex: 1;
		text-align: center;
		position: relative;
		z-index: 1;
	}

	.progress-step-circle {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		background: #e0e0e0;
		color: #666;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-weight: bold;
		margin-bottom: 8px;
	}

	.progress-step.active .progress-step-circle {
		background: #007bff;
		color: white;
	}

	.progress-step.completed .progress-step-circle {
		background: #28a745;
		color: white;
	}

	.progress-step-label {
		font-size: 12px;
		color: #666;
	}

	.form-section {
		margin-bottom: 30px;
	}

	.form-section h3 {
		margin-bottom: 20px;
		color: #333;
		font-size: 24px;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-group label {
		display: block;
		margin-bottom: 8px;
		font-weight: 600;
		color: #333;
	}

	.form-group label.required::after {
		content: " *";
		color: red;
	}

	.form-group .description {
		font-size: 12px;
		color: #666;
		margin-top: 5px;
		font-style: italic;
	}

	.form-control {
		width: 100%;
		padding: 12px;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-size: 14px;
		box-sizing: border-box;
	}

	.form-control:focus {
		outline: none;
		border-color: #007bff;
	}

	textarea.form-control {
		min-height: 100px;
		resize: vertical;
	}

	.btn-container {
		display: flex;
		justify-content: space-between;
		margin-top: 30px;
	}

	.btn {
		padding: 12px 30px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 16px;
		font-weight: 600;
		transition: all 0.3s;
	}

	.btn-primary {
		background: #007bff;
		color: white;
	}

	.btn-primary:hover {
		background: #0056b3;
	}

	.btn-primary:disabled {
		background: #6c757d;
		cursor: not-allowed;
	}

	.btn-secondary {
		background: #6c757d;
		color: white;
	}

	.btn-secondary:hover {
		background: #545b62;
	}

	.alert {
		padding: 15px;
		border-radius: 4px;
		margin-bottom: 20px;
	}

	.alert-success {
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.alert-danger {
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.alert-info {
		background: #d1ecf1;
		color: #0c5460;
		border: 1px solid #bee5eb;
	}

	.step-content {
		display: none;
	}

	.step-content.active {
		display: block;
	}

	.appointment-type-options {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 20px;
		margin: 20px 0;
	}

	.appointment-type-option {
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		cursor: pointer;
		text-align: center;
		transition: all 0.3s;
	}

	.appointment-type-option:hover {
		border-color: #007bff;
	}

	.appointment-type-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
	}

	.appointment-type-option h4 {
		margin: 0 0 10px 0;
		color: #333;
	}

	.info-box {
		background: #fff3cd;
		border: 1px solid #ffc107;
		border-radius: 4px;
		padding: 15px;
		margin: 15px 0;
		color: #856404;
		font-size: 14px;
		line-height: 1.6;
	}

	.info-box.warning {
		background: #f8d7da;
		border-color: #dc3545;
		color: #721c24;
	}

	.checkbox-group {
		display: flex;
		align-items: flex-start;
		margin: 15px 0;
	}

	.checkbox-group input[type="checkbox"] {
		margin-right: 10px;
		margin-top: 3px;
	}

	.checkbox-group label {
		font-weight: normal;
		cursor: pointer;
	}

	.location-options {
		display: flex;
		gap: 20px;
		margin-bottom: 30px;
	}

	.location-option {
		flex: 1;
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		cursor: pointer;
		text-align: center;
		transition: all 0.3s;
	}

	.location-option:hover {
		border-color: #007bff;
	}

	.location-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
	}

	.location-option-icon {
		font-size: 40px;
		margin-bottom: 10px;
	}

	.location-option-title {
		font-weight: 600;
		font-size: 16px;
	}

	.location-details {
		display: none;
		margin-top: 20px;
	}

	.location-details.show {
		display: block;
	}

	.date-time-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 30px;
		margin-top: 20px;
	}

	.date-picker-section,
	.time-picker-section {
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		background: #f8f9fa;
	}

	.section-title {
		font-weight: 600;
		font-size: 16px;
		margin-bottom: 15px;
		color: #333;
	}

	.available-dates-list {
		max-height: 300px;
		overflow-y: auto;
		margin-top: 15px;
	}

	.date-option {
		padding: 12px 15px;
		margin-bottom: 8px;
		border: 2px solid #e0e0e0;
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.3s;
		background: white;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.date-option:hover {
		border-color: #007bff;
		background: #f0f8ff;
	}

	.date-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
		font-weight: 600;
	}

	.date-option-label {
		font-size: 14px;
	}

	.date-option-count {
		font-size: 12px;
		color: #666;
		background: #e0e0e0;
		padding: 3px 8px;
		border-radius: 12px;
	}

	.time-slots-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
		gap: 10px;
		max-height: 350px;
		overflow-y: auto;
	}

	.time-slot {
		border: 2px solid #e0e0e0;
		border-radius: 6px;
		padding: 12px 8px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s;
		background: white;
		font-size: 14px;
		font-weight: 500;
	}

	.time-slot:hover {
		border-color: #007bff;
		background: #f0f8ff;
		transform: translateY(-2px);
		box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
	}

	.time-slot.selected {
		border-color: #007bff;
		background: #007bff;
		color: white;
	}

	.no-selection-message {
		padding: 40px 20px;
		text-align: center;
		color: #999;
		font-style: italic;
	}

	@media (max-width: 768px) {
		.appointment-type-options {
			grid-template-columns: 1fr;
		}

		.location-options {
			flex-direction: column;
		}

		.date-time-container {
			grid-template-columns: 1fr;
		}

		.appointment-container {
			padding: 20px;
			margin: 20px;
		}
	}
</style>

<div class="appointment-container">
	<h2 style="text-align: center; margin-bottom: 30px;">{{ _("Video Production Appointment") }}</h2>

	<!-- Progress Bar -->
	<div class="progress-bar-container" id="progress-bar">
		<div class="progress-step" data-step="1">
			<div class="progress-step-circle">1</div>
			<div class="progress-step-label">{{ _("Information") }}</div>
		</div>
		<div class="progress-step" data-step="2">
			<div class="progress-step-circle">2</div>
			<div class="progress-step-label">{{ _("Appointment Details") }}</div>
		</div>
		<div class="progress-step" data-step="3">
			<div class="progress-step-circle">3</div>
			<div class="progress-step-label">{{ _("Location") }}</div>
		</div>
		<div class="progress-step" data-step="4">
			<div class="progress-step-circle">4</div>
			<div class="progress-step-label">{{ _("Date & Time") }}</div>
		</div>
		<div class="progress-step" data-step="5">
			<div class="progress-step-circle">‚úì</div>
			<div class="progress-step-label">{{ _("Success") }}</div>
		</div>
	</div>

	<!-- Step 1: Customer Information -->
	<div class="step-content active" id="step-1">
		<div class="form-section">
			<h3>{{ _("Information") }}</h3>

			<div class="form-group">
				<label class="required">{{ _("Name") }}</label>
				<input type="text" id="customer_name" class="form-control" required>
				<div id="customer_name_error" class="field-error"
					style="display: none; color: red; font-size: 12px; margin-top: 5px;"></div>
			</div>

			<div class="form-group">
				<label class="required">{{ _("Number") }}</label>
				<input type="tel" id="phone_number" class="form-control" required>
				<div id="phone_number_error" class="field-error"
					style="display: none; color: red; font-size: 12px; margin-top: 5px;"></div>
			</div>

			<div class="form-group">
				<label class="required">{{ _("Email") }}</label>
				<input type="email" id="email" class="form-control" required>
				<div id="email_error" class="field-error"
					style="display: none; color: red; font-size: 12px; margin-top: 5px;"></div>
			</div>
		</div>

		<div class="btn-container">
			<div></div>
			<button class="btn btn-primary" onclick="goToStep(2)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 2: Appointment Type and Details -->
	<div class="step-content" id="step-2">
		<div class="form-section">
			<h3>{{ _("Appointment Type") }}</h3>

			<div class="appointment-type-options">
				<div class="appointment-type-option" onclick="selectAppointmentType('New Customer')">
					<h4>{{ _("New Customer") }}</h4>
					<p>{{ _("I am a new customer") }}</p>
				</div>

				<div class="appointment-type-option" onclick="selectAppointmentType('Current Active Client')">
					<h4>{{ _("Current Active Client") }}</h4>
					<p>{{ _("I am an existing active client") }}</p>
				</div>
			</div>

			<!-- New Customer Form -->
			<div id="new-customer-form" style="display: none;">
				<h3 style="margin-top: 30px;">{{ _("New Customer Details") }}</h3>

				<div class="form-group">
					<label class="required">{{ _("Industry") }}</label>
					<select id="industry" class="form-control" required onchange="onIndustryChange()">
						<option value="">{{ _("Select Industry") }}</option>
						<option value="Food & Hospitality">{{ _("Food & Hospitality") }}</option>
						<option value="Healthcare">{{ _("Healthcare") }}</option>
						<option value="Beauty & Fashion">{{ _("Beauty & Fashion") }}</option>
						<option value="Real Estate">{{ _("Real Estate") }}</option>
						<option value="Automotive">{{ _("Automotive") }}</option>
						<option value="Education">{{ _("Education") }}</option>
						<option value="Sports & Fitness">{{ _("Sports & Fitness") }}</option>
						<option value="Technology & Digital Services">{{ _("Technology & Digital Services") }}</option>
						<option value="Commerce & Retail">{{ _("Commerce & Retail") }}</option>
						<option value="Professional Services">{{ _("Professional Services") }}</option>
						<option value="Travel & Tourism">{{ _("Travel & Tourism") }}</option>
						<option value="Construction & Contracting">{{ _("Construction & Contracting") }}</option>
						<option value="Events & Entertainment">{{ _("Events & Entertainment") }}</option>
						<option value="Finance">{{ _("Finance") }}</option>
						<option value="Others">{{ _("Others") }}</option>
					</select>
				</div>

				<div class="form-group" id="service-group" style="display: none;">
					<label class="required">{{ _("Service") }}</label>
					<select id="service" class="form-control" required>
						<option value="">{{ _("Select Service") }}</option>
					</select>
				</div>

				<div class="form-group">
					<label class="required">{{ _("Requirements") }}</label>
					<select id="requirements" class="form-control" required>
						<option value="">{{ _("Select Requirements") }}</option>
						<option value="Photos">{{ _("Photos") }}</option>
						<option value="Videos">{{ _("Videos") }}</option>
						<option value="Both">{{ _("Both") }}</option>
					</select>
				</div>

				<div class="form-group">
					<label class="required">{{ _("Budget") }}</label>
					<select id="budget" class="form-control" required>
						<option value="">{{ _("Select Budget") }}</option>
						<option value="Low">{{ _("Low") }}</option>
						<option value="Medium">{{ _("Medium") }}</option>
						<option value="Open">{{ _("Open") }}</option>
					</select>
				</div>

				<div class="form-group">
					<label>{{ _("Notes") }}</label>
					<textarea id="notes" class="form-control"
						readonly>Please check our previous projects and determine your requirements and one of our sales team will contact you ASAP</textarea>
				</div>

				<div class="form-group">
					<label>{{ _("References") }}</label>
					<div id="references-container" class="form-control"
						style="min-height: 100px; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;"
						contenteditable="true"></div>
					<input type="hidden" id="references" />
				</div>
			</div>

			<!-- Current Active Client Form -->
			<div id="current-client-form" style="display: none;">
				<h3 style="margin-top: 30px;">{{ _("Current Active Client Details") }}</h3>

				<div class="info-box warning">
					<strong>{{ _("Note:") }}</strong> {{ _("Please make sure you are an active client with us. If you
					are not a client with us, the appointment will be cancelled automatically.") }}
				</div>

				<div class="form-group">
					<label class="required">{{ _("Name of Your Brand") }}</label>
					<input type="text" id="brand_name" class="form-control" required>
				</div>


				<div class="info-box">
					<strong>{{ _("Note 1:") }}</strong> {{ _("If you want to cancel, you should cancel before 48H at
					least or we will consider the photoshoot is done.") }}<br>
					<strong>{{ _("Note 2:") }}</strong> {{ _("Storyboard and mood board will be discussed with our
					operation manager before photoshoot.") }}
				</div>

				<div class="checkbox-group">
					<input type="checkbox" id="acknowledgment_checkbox" required>
					<label for="acknowledgment_checkbox">{{ _("I acknowledge the cancellation policy") }}</label>
				</div>

				<div class="form-group">
					<label>{{ _("References") }}</label>
					<div id="current_client_references-container" class="form-control"
						style="min-height: 100px; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;"
						contenteditable="true"></div>
					<input type="hidden" id="current_client_references" />
				</div>
			</div>
		</div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(1)">{{ _("Back") }}</button>
			<button class="btn btn-primary" onclick="goToStep(3)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 3: Location Selection -->
	<div class="step-content" id="step-3">
		<div class="form-section">
			<h3>{{ _("Customer Location") }}</h3>

			<!-- Customer Location Form -->
			<div id="customer-location-form" class="location-details show">
				<div class="form-group">
					<label class="required">{{ _("Google location") }}</label>
					<input type="text" id="google_location" class="form-control"
						placeholder="{{ _('Enter Google Maps location or coordinates') }}">
				</div>

				<div class="form-group">
					<label class="required">{{ _("City") }}</label>
					<select id="city" class="form-control" required>
						<option value="">{{ _("Select City") }}</option>
						<option value="Doha">{{ _("Doha") }}</option>
						<option value="Al Rayyan">{{ _("Al Rayyan") }}</option>
						<option value="Al Wakrah">{{ _("Al Wakrah") }}</option>
						<option value="Umm Salal">{{ _("Umm Salal") }}</option>
						<option value="Al Khor">{{ _("Al Khor") }}</option>
						<option value="Al Shamal">{{ _("Al Shamal") }}</option>
						<option value="Al Daayen">{{ _("Al Daayen") }}</option>
						<option value="Al Shahaniya">{{ _("Al Shahaniya") }}</option>
						<option value="Al Wukair">{{ _("Al Wukair") }}</option>
						<option value="Al Thumama">{{ _("Al Thumama") }}</option>
						<option value="Lusail">{{ _("Lusail") }}</option>
						<option value="Mesaieed">{{ _("Mesaieed") }}</option>
						<option value="Dukhan">{{ _("Dukhan") }}</option>
						<option value="Ras Laffan">{{ _("Ras Laffan") }}</option>
						<option value="Madinat Khalifa">{{ _("Madinat Khalifa") }}</option>
						<option value="Al Gharrafa">{{ _("Al Gharrafa") }}</option>
						<option value="Al Sadd">{{ _("Al Sadd") }}</option>
						<option value="Al Mansoura">{{ _("Al Mansoura") }}</option>
						<option value="Al Markhiya">{{ _("Al Markhiya") }}</option>
						<option value="The Pearl">{{ _("The Pearl") }}</option>
						<option value="West Bay">{{ _("West Bay") }}</option>
						<option value="Al Waab">{{ _("Al Waab") }}</option>
						<option value="Ain Khaled">{{ _("Ain Khaled") }}</option>
						<option value="Abu Hamour">{{ _("Abu Hamour") }}</option>
						<option value="Old Airport">{{ _("Old Airport") }}</option>
						<option value="Muaither">{{ _("Muaither") }}</option>
						<option value="Al Kheesa">{{ _("Al Kheesa") }}</option>
						<option value="Al Mashaf">{{ _("Al Mashaf") }}</option>
						<option value="Other Known Cities / Towns">{{ _("Other Known Cities / Towns") }}</option>
					</select>
					<div class="description" style="margin-top: 5px; color: #856404; font-style: italic;">{{ _("Note :
						Extra charge will be applied for Any Area outside Doha") }}</div>
				</div>

				<div class="form-group">
					<label class="required">{{ _("Zone Number") }}</label>
					<input type="text" id="zone_number" class="form-control">
				</div>

				<div class="form-group">
					<label class="required">{{ _("Street Number") }}</label>
					<input type="text" id="street_number" class="form-control">
				</div>

				<div class="form-group">
					<label class="required">{{ _("Building Number") }}</label>
					<input type="text" id="building_number" class="form-control">
				</div>
			</div>
		</div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(2)">{{ _("Back") }}</button>
			<button class="btn btn-primary" onclick="goToStep(4)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 4: Date and Time Selection -->
	<div class="step-content" id="step-4">
		<div class="form-section">
			<h3>{{ _("Select Date and Time") }}</h3>

			<div class="date-time-container">
				<!-- Date Selection -->
				<div class="date-picker-section">
					<div class="section-title">üìÖ {{ _("1. Select a Date") }}</div>
					<div id="available-dates-container">
						<div style="padding: 20px; text-align: center;">{{ _("Loading available dates...") }}</div>
					</div>
				</div>

				<!-- Time Selection -->
				<div class="time-picker-section">
					<div class="section-title">‚è∞ {{ _("2. Select a Time") }}</div>
					<div id="time-slots-container">
						<div class="no-selection-message">
							{{ _("Please select a date first") }}
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="alert-message" style="display: none;"></div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(3)">{{ _("Back") }}</button>
			<button class="btn btn-primary" id="submit-btn" onclick="submitAppointment()">{{ _("Submit") }}</button>
		</div>
	</div>

	<!-- Step 5: Success Page -->
	<div class="step-content" id="step-5">
		<div class="form-section" style="text-align: center; padding: 40px 20px;">
			<div style="font-size: 80px; color: #28a745; margin-bottom: 20px;">‚úì</div>
			<h2 style="color: #28a745; margin-bottom: 20px;">{{ _("our application has been submitted successfully") }}
			</h2>
			<h3 style="color: #333; margin-top: 40px; margin-bottom: 20px;">{{ _("Be Ready at your Session") }}</h3>
		</div>
	</div>
</div>

<script>
	// App state
	const appState = {
		currentStep: 1,
		company: 'Directlines', // Always Directlines for this page
		customerName: '',
		phoneNumber: '',
		email: '',
		appointmentType: '',
		// New Customer fields
		industry: '',
		service: '',
		requirements: '',
		budget: '',
		notes: '',
		references: '',
		// Current Active Client fields
		brandName: '',
		acknowledgmentCheckbox: false,
		currentClientReferences: '',
		// Location fields
		meetingLocation: 'Customer Location', // Always Customer Location for Direct Line
		googleLocation: '',
		city: '',
		zoneNumber: '',
		streetNumber: '',
		buildingNumber: '',
		companyLocation: '',
		// Date & Time fields
		bookingDate: '',
		bookingTime: '',
		bookingTimeTo: '',
		availableSlots: [],
		selectedDate: null,
		slotsByDate: {}
	};

	// Initialize on page load
	document.addEventListener('DOMContentLoaded', function () {
		console.log('Video production page loaded, initializing...');
		loadCompanyLocation();
		loadTimeSlots();
		updateProgressBar();
		// Initialize reference fields after a short delay to ensure DOM is ready
		setTimeout(function () {
			setupReferenceField('references-container', 'references');
			setupReferenceField('current_client_references-container', 'current_client_references');
		}, 100);
		console.log('Video production initialization complete');
	});

	// Navigation
	function goToStep(step) {
		// Save reference fields before navigation
		const referencesContainer = document.getElementById('references-container');
		const currentClientReferencesContainer = document.getElementById('current_client_references-container');

		if (referencesContainer && !referencesContainer.classList.contains('placeholder')) {
			const text = referencesContainer.innerText.trim();
			const hiddenInput = document.getElementById('references');
			if (hiddenInput) hiddenInput.value = text;
		}

		if (currentClientReferencesContainer && !currentClientReferencesContainer.classList.contains('placeholder')) {
			const text = currentClientReferencesContainer.innerText.trim();
			const hiddenInput = document.getElementById('current_client_references');
			if (hiddenInput) hiddenInput.value = text;
		}

		// Validate current step before moving forward
		if (step > appState.currentStep && !validateCurrentStep()) {
			return;
		}

		// Save current step data
		saveStepData(appState.currentStep);

		// Hide all steps
		document.querySelectorAll('.step-content').forEach(el => {
			el.classList.remove('active');
		});

		// Show target step
		const targetStep = document.getElementById('step-' + step);
		if (targetStep) {
			targetStep.classList.add('active');
			appState.currentStep = step;

			// Update progress bar
			updateProgressBar();

			// Scroll to top
			window.scrollTo(0, 0);
		}
	}

	function updateProgressBar() {
		const steps = document.querySelectorAll('.progress-step');
		steps.forEach((step, index) => {
			const stepNum = parseInt(step.getAttribute('data-step'));
			step.classList.remove('active', 'completed');

			if (stepNum < appState.currentStep) {
				step.classList.add('completed');
			} else if (stepNum === appState.currentStep) {
				step.classList.add('active');
			}
		});
	}

	function validateCurrentStep() {
		const step = appState.currentStep;

		if (step === 1) {
			const name = document.getElementById('customer_name').value.trim();
			const phone = document.getElementById('phone_number').value.trim();
			const email = document.getElementById('email').value.trim();
			let isValid = true;

			// Clear previous errors
			document.getElementById('customer_name_error').style.display = 'none';
			document.getElementById('phone_number_error').style.display = 'none';
			document.getElementById('email_error').style.display = 'none';

			// Validate Name - letters only (English and Arabic)
			if (!name) {
				document.getElementById('customer_name_error').textContent = '{{ _("Name is required") }}';
				document.getElementById('customer_name_error').style.display = 'block';
				isValid = false;
			} else if (!/^[\p{L}\s]+$/u.test(name)) {
				document.getElementById('customer_name_error').textContent = '{{ _("Name should contain only letters") }}';
				document.getElementById('customer_name_error').style.display = 'block';
				isValid = false;
			}

			// Validate Number - numbers only
			if (!phone) {
				document.getElementById('phone_number_error').textContent = '{{ _("Number is required") }}';
				document.getElementById('phone_number_error').style.display = 'block';
				isValid = false;
			} else if (!/^\d+$/.test(phone)) {
				document.getElementById('phone_number_error').textContent = '{{ _("Number should contain only digits") }}';
				document.getElementById('phone_number_error').style.display = 'block';
				isValid = false;
			}

			// Validate Email - email format
			if (!email) {
				document.getElementById('email_error').textContent = '{{ _("Email is required") }}';
				document.getElementById('email_error').style.display = 'block';
				isValid = false;
			} else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
				document.getElementById('email_error').textContent = '{{ _("Please enter a valid email address") }}';
				document.getElementById('email_error').style.display = 'block';
				isValid = false;
			}

			return isValid;
		}

		if (step === 2) {
			if (!appState.appointmentType) {
				alert('{{ _("Please select an appointment type") }}');
				return false;
			}

			if (appState.appointmentType === 'New Customer') {
				const industry = document.getElementById('industry').value;
				const serviceGroup = document.getElementById('service-group');
				const service = serviceGroup.style.display !== 'none' ? document.getElementById('service').value : '';
				const requirements = document.getElementById('requirements').value;
				const budget = document.getElementById('budget').value;

				if (!industry || !requirements || !budget) {
					alert('{{ _("Please fill in all required fields for New Customer") }}');
					return false;
				}

				if (serviceGroup.style.display !== 'none' && !service) {
					alert('{{ _("Please select a service") }}');
					return false;
				}
			} else {
				const brandName = document.getElementById('brand_name').value.trim();
				const acknowledgment = document.getElementById('acknowledgment_checkbox').checked;

				if (!brandName || !acknowledgment) {
					alert('{{ _("Please fill in all required fields and acknowledge the cancellation policy") }}');
					return false;
				}
			}
		}

		if (step === 3) {
			const googleLoc = document.getElementById('google_location').value.trim();
			const city = document.getElementById('city').value;
			const zone = document.getElementById('zone_number').value.trim();
			const street = document.getElementById('street_number').value.trim();
			const building = document.getElementById('building_number').value.trim();

			if (!googleLoc || !city || !zone || !street || !building) {
				alert('{{ _("Please fill in all location details") }}');
				return false;
			}
		}

		if (step === 4) {
			if (!appState.bookingDate || !appState.bookingTime) {
				alert('{{ _("Please select a date and time") }}');
				return false;
			}
		}

		return true;
	}

	function saveStepData(step) {
		if (step === 1) {
			appState.customerName = document.getElementById('customer_name').value;
			appState.phoneNumber = document.getElementById('phone_number').value;
			appState.email = document.getElementById('email').value;
		}

		if (step === 2) {
			if (appState.appointmentType === 'New Customer') {
				appState.industry = document.getElementById('industry').value;
				const serviceGroup = document.getElementById('service-group');
				appState.service = serviceGroup.style.display !== 'none' ? document.getElementById('service').value : '';
				appState.requirements = document.getElementById('requirements').value;
				appState.budget = document.getElementById('budget').value;
				appState.notes = document.getElementById('notes') ? document.getElementById('notes').value : '';
				appState.references = document.getElementById('references').value;
			} else {
				appState.brandName = document.getElementById('brand_name').value;
				appState.acknowledgmentCheckbox = document.getElementById('acknowledgment_checkbox').checked;
				appState.currentClientReferences = document.getElementById('current_client_references').value;
			}
		}

		if (step === 3) {
			appState.googleLocation = document.getElementById('google_location').value;
			appState.city = document.getElementById('city').value;
			appState.zoneNumber = document.getElementById('zone_number').value;
			appState.streetNumber = document.getElementById('street_number').value;
			appState.buildingNumber = document.getElementById('building_number').value;
		}
	}

	// Load Company Location
	function loadCompanyLocation() {
		frappe.call({
			method: 'appointment_addons.www.book-appointment.get_company_location',
			callback: function (r) {
				if (r.message) {
					appState.companyLocation = r.message;
					const locationText = document.getElementById('company-location-text');
					if (locationText) {
						locationText.textContent = r.message || '{{ _("Location not set. Please contact administrator.") }}';
					}
				}
			}
		});
	}

	// Location Selection (Not used for Direct Line, always Customer Location)
	function selectLocation(locationType) {
		// This function is kept for compatibility but not used for Direct Line
	}

	// Load Time Slots
	function loadTimeSlots() {
		frappe.call({
			method: 'appointment_addons.www.book-appointment.get_time_slots',
			callback: function (r) {
				console.log('Time slots response:', r);
				if (r.message) {
					console.log('Time slots received:', r.message);
					appState.availableSlots = r.message;
					groupSlotsByDate();
					renderAvailableDates();
				} else {
					console.error('No time slots received');
					const container = document.getElementById('available-dates-container');
					if (container) {
						container.innerHTML = '<div class="alert alert-danger">No available dates. Please check Appointment Booking Settings.</div>';
					}
				}
			},
			error: function (r) {
				console.error('Error loading time slots:', r);
				const container = document.getElementById('available-dates-container');
				if (container) {
					container.innerHTML = '<div class="alert alert-danger">Error loading time slots. Please try again.</div>';
				}
			}
		});
	}

	function groupSlotsByDate() {
		appState.slotsByDate = {};

		console.log('Grouping slots:', appState.availableSlots);

		if (!appState.availableSlots || appState.availableSlots.length === 0) {
			console.warn('No available slots to group');
			return;
		}

		appState.availableSlots.forEach(slot => {
			if (!appState.slotsByDate[slot.date]) {
				appState.slotsByDate[slot.date] = {
					date: slot.date,
					date_display: slot.date_display,
					day: slot.day,
					slots: []
				};
			}
			appState.slotsByDate[slot.date].slots.push(slot);
		});

		console.log('Grouped slots by date:', appState.slotsByDate);
	}

	function renderAvailableDates() {
		const container = document.getElementById('available-dates-container');
		if (!container) return;

		const dates = Object.values(appState.slotsByDate);

		console.log('Rendering dates:', dates);

		if (dates.length === 0) {
			console.warn('No dates to render');
			container.innerHTML = '<div class="alert alert-danger">{{ _("No available dates at the moment. Please check Appointment Booking Settings and ensure availability slots are configured.") }}</div>';
			return;
		}

		container.innerHTML = '<div class="available-dates-list"></div>';
		const list = container.querySelector('.available-dates-list');

		dates.forEach(dateInfo => {
			const dateEl = document.createElement('div');
			dateEl.className = 'date-option';
			if (appState.selectedDate === dateInfo.date) {
				dateEl.classList.add('selected');
			}

			dateEl.onclick = () => selectDate(dateInfo.date);

			const slotsCount = dateInfo.slots.length;
			const slotText = slotsCount === 1 ? '{{ _("slot") }}' : '{{ _("slots") }}';

			dateEl.innerHTML = `
			<div>
				<div class="date-option-label">${dateInfo.date_display}</div>
				<div style="font-size: 12px; color: #666; margin-top: 2px;">${dateInfo.day}</div>
			</div>
			<div class="date-option-count">${slotsCount} ${slotText}</div>
		`;

			list.appendChild(dateEl);
		});
	}

	function selectDate(date) {
		appState.selectedDate = date;
		appState.bookingDate = date;
		appState.bookingTime = ''; // Reset time selection

		renderAvailableDates();
		renderTimeSlotsForDate(date);
	}

	function renderTimeSlotsForDate(date) {
		const container = document.getElementById('time-slots-container');
		if (!container) return;

		const dateInfo = appState.slotsByDate[date];

		if (!dateInfo || dateInfo.slots.length === 0) {
			container.innerHTML = '<div class="no-selection-message">{{ _("No available times for this date") }}</div>';
			return;
		}

		container.innerHTML = '<div class="time-slots-grid"></div>';
		const grid = container.querySelector('.time-slots-grid');

		dateInfo.slots.forEach(slot => {
			const timeEl = document.createElement('div');
			timeEl.className = 'time-slot';
			const slotKey = slot.from_time + '-' + (slot.to_time || '');
			if (appState.bookingTime === slot.from_time) {
				timeEl.classList.add('selected');
			}

			timeEl.onclick = () => selectTimeSlot(slot.from_time, slot.to_time);

			// Display time range if to_time is available, otherwise just from_time
			const timeDisplay = slot.to_time ? `${slot.from_time} : ${slot.to_time}` : `${slot.from_time}`;
			timeEl.innerHTML = timeDisplay;

			grid.appendChild(timeEl);
		});
	}

	function selectTimeSlot(time, toTime) {
		appState.bookingTime = time;
		appState.bookingTimeTo = toTime || '';
		renderTimeSlotsForDate(appState.selectedDate);
	}

	function selectAppointmentType(type) {
		appState.appointmentType = type;

		// Update visual selection
		document.querySelectorAll('.appointment-type-option').forEach(opt => {
			opt.classList.remove('selected');
		});
		event.currentTarget.classList.add('selected');

		// Show/hide forms
		const newCustomerForm = document.getElementById('new-customer-form');
		const currentClientForm = document.getElementById('current-client-form');

		if (type === 'New Customer') {
			newCustomerForm.style.display = 'block';
			currentClientForm.style.display = 'none';
			// Initialize reference field
			setupReferenceField('references-container', 'references');
		} else {
			newCustomerForm.style.display = 'none';
			currentClientForm.style.display = 'block';
			// Initialize reference field
			setupReferenceField('current_client_references-container', 'current_client_references');
		}
	}

	// Industry to Service mapping
	const industryServices = {
		'Food & Hospitality': ['Restaurants', 'Caf√©s', 'Bakeries', 'Catering'],
		'Healthcare': ['Clinics', 'Dental Clinics', 'Dermatology', 'Hospitals', 'Pharmacies', 'Wellness Centers', 'Nutrition & Diet Services'],
		'Beauty & Fashion': ['Beauty Salons', 'Spas', 'Nail Bars', 'Barbershops', 'Cosmetics Brands', 'Fashion Boutiques'],
		'Real Estate': ['Real Estate Agencies', 'Developers', 'Property Management', 'Interior Design', 'Furniture Stores'],
		'Automotive': ['Car Dealers', 'Car Rentals', 'Workshops', 'Car Detailing', 'Spare Parts'],
		'Education': ['Schools', 'Nurseries', 'Training Centers', 'Universities', 'Online Courses'],
		'Sports & Fitness': ['Gyms', 'Personal Trainers', 'Sports Clubs', 'Yoga/Pilates Studios', 'Sports Academies'],
		'Technology & Digital Services': ['IT Companies', 'Software', 'Apps', 'Web Agencies', 'Cybersecurity', 'Hosting Services'],
		'Commerce & Retail': ['E-commerce', 'Retail Stores', 'Supermarkets', 'Jewelry', 'Perfume Stores', 'Home Appliances'],
		'Professional Services': ['Law Firms', 'Accounting', 'Consulting', 'HR Agencies', 'Recruitment'],
		'Travel & Tourism': ['Travel Agencies', 'Tour Guides', 'Airlines', 'Transport Services'],
		'Construction & Contracting': ['Contractors', 'Engineering Offices', 'Maintenance', 'MEP', 'Landscaping'],
		'Events & Entertainment': ['Event Management', 'Photographers', 'Florists', 'Entertainment Companies', 'Musicians'],
		'Finance': ['Banks', 'Insurance', 'FinTech', 'Investment Firms'],
		'Others': []
	};

	function onIndustryChange() {
		const industry = document.getElementById('industry').value;
		const serviceGroup = document.getElementById('service-group');
		const serviceSelect = document.getElementById('service');

		if (industry && industry !== 'Others' && industryServices[industry]) {
			serviceGroup.style.display = 'block';
			serviceSelect.innerHTML = '<option value="">{{ _("Select Service") }}</option>';

			industryServices[industry].forEach(service => {
				const option = document.createElement('option');
				option.value = service;
				option.textContent = service;
				serviceSelect.appendChild(option);
			});
			serviceSelect.required = true;
		} else {
			serviceGroup.style.display = 'none';
			serviceSelect.value = '';
			serviceSelect.required = false;
		}
	}

	// Setup reference field with link detection
	function setupReferenceField(containerId, hiddenInputId) {
		const container = document.getElementById(containerId);
		const hiddenInput = document.getElementById(hiddenInputId);

		if (!container) return;

		// Initialize with placeholder
		if (!container.textContent.trim()) {
			container.textContent = 'share links for videos and photos that you like ';
			container.style.color = '#999';
			container.classList.add('placeholder');
		}

		container.addEventListener('focus', function () {
			if (this.classList.contains('placeholder')) {
				this.textContent = '';
				this.style.color = '#333';
				this.classList.remove('placeholder');
			}
		});

		container.addEventListener('blur', function () {
			let text = this.innerText.trim();
			if (text === '') {
				this.textContent = 'share links for videos and photos that you like ';
				this.style.color = '#999';
				this.classList.add('placeholder');
				if (hiddenInput) hiddenInput.value = '';
			} else {
				// Update hidden input with plain text
				if (hiddenInput) hiddenInput.value = text;
				// Render links
				renderReferenceLinks(this, text);
			}
		});

		container.addEventListener('input', function () {
			// While typing, store plain text in hidden input
			let text = this.innerText.trim();
			if (hiddenInput && !this.classList.contains('placeholder')) {
				hiddenInput.value = text;
			}
		});
	}

	function renderReferenceLinks(container, text) {
		// Detect URLs and convert to links
		const urlRegex = /(https?:\/\/[^\s]+)/g;

		// Check if text contains URLs
		if (!urlRegex.test(text)) {
			// No URLs, just set as plain text with line breaks
			container.innerHTML = text.replace(/\n/g, '<br>');
			return;
		}

		// Split by URLs and build HTML
		const parts = text.split(urlRegex);
		let htmlContent = '';

		parts.forEach(part => {
			if (urlRegex.test(part)) {
				// It's a URL, make it a link
				htmlContent += `<a href="${part}" target="_blank" style="color: #007bff; text-decoration: underline;">${part}</a>`;
			} else {
				// Regular text, preserve line breaks
				htmlContent += part.replace(/\n/g, '<br>');
			}
		});

		container.innerHTML = htmlContent;
		container.style.color = '#333';
	}

	// Submit Appointment
	function submitAppointment() {
		if (!validateCurrentStep()) {
			return;
		}

		// Save all data
		saveStepData(2);
		saveStepData(3);

		const submitBtn = document.getElementById('submit-btn');
		const alertDiv = document.getElementById('alert-message');

		// Disable submit button
		submitBtn.disabled = true;
		submitBtn.textContent = '{{ _("Submitting...") }}';

		// Prepare data
		const data = {
			company: appState.company,
			customer_name: appState.customerName,
			phone_number: appState.phoneNumber,
			email: appState.email,
			appointment_type: appState.appointmentType,
			industry: appState.industry,
			service: appState.service,
			requirements: appState.requirements,
			budget: appState.budget,
			notes: appState.notes,
			references: appState.references,
			brand_name: appState.brandName,
			acknowledgment_checkbox: appState.acknowledgmentCheckbox ? 1 : 0,
			current_client_references: appState.currentClientReferences,
			// Location data
			meeting_location: appState.meetingLocation,
			google_location: appState.googleLocation,
			city: appState.city,
			zone_number: appState.zoneNumber,
			street_number: appState.streetNumber,
			building_number: appState.buildingNumber,
			// Date & Time data
			booking_date: appState.bookingDate,
			booking_time: appState.bookingTime
		};

		frappe.call({
			method: 'appointment_addons.www.video-production-appointment.create_appointment',
			args: {
				data: data
			},
			callback: function (r) {
				if (r.message && r.message.success) {
					// Show success page
					goToStep(5);
				} else {
					alertDiv.className = 'alert alert-danger';
					alertDiv.textContent = r.message ? r.message.message : '{{ _("An error occurred. Please try again.") }}';
					alertDiv.style.display = 'block';
					submitBtn.disabled = false;
					submitBtn.textContent = '{{ _("Submit") }}';
				}
			},
			error: function () {
				alertDiv.className = 'alert alert-danger';
				alertDiv.textContent = '{{ _("Network error. Please check your connection and try again.") }}';
				alertDiv.style.display = 'block';
				submitBtn.disabled = false;
				submitBtn.textContent = '{{ _("Submit") }}';
			}
		});
	}
</script>

{% endblock %}