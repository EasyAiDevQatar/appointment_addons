{% extends "templates/web.html" %}

{% block title %}{{ _("Book Appointment") }}{% endblock %}

{% block page_content %}
<style>
	.appointment-container {
		max-width: 800px;
		margin: 40px auto;
		padding: 30px;
		background: #fff;
		border-radius: 8px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.progress-bar-container {
		display: flex;
		justify-content: space-between;
		margin-bottom: 40px;
		position: relative;
	}

	.progress-bar-container::before {
		content: '';
		position: absolute;
		top: 20px;
		left: 0;
		right: 0;
		height: 2px;
		background: #e0e0e0;
		z-index: 0;
	}

	.progress-step {
		flex: 1;
		text-align: center;
		position: relative;
		z-index: 1;
	}

	.progress-step-circle {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		background: #e0e0e0;
		color: #666;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-weight: bold;
		margin-bottom: 8px;
	}

	.progress-step.active .progress-step-circle {
		background: #007bff;
		color: white;
	}

	.progress-step.completed .progress-step-circle {
		background: #28a745;
		color: white;
	}

	.progress-step-label {
		font-size: 12px;
		color: #666;
	}

	.form-section {
		margin-bottom: 20px;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-group label {
		display: block;
		margin-bottom: 8px;
		font-weight: 600;
		color: #333;
	}

	.form-group label.required::after {
		content: " *";
		color: red;
	}

	.form-control {
		width: 100%;
		padding: 10px;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-size: 14px;
	}

	.form-control:focus {
		outline: none;
		border-color: #007bff;
	}

	.btn-container {
		display: flex;
		justify-content: space-between;
		margin-top: 30px;
	}

	.btn {
		padding: 12px 30px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 16px;
		font-weight: 600;
	}

	.btn-primary {
		background: #007bff;
		color: white;
	}

	.btn-primary:hover {
		background: #0056b3;
	}

	.btn-secondary {
		background: #6c757d;
		color: white;
	}

	.btn-secondary:hover {
		background: #545b62;
	}

	.services-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		gap: 15px;
		margin-top: 20px;
	}

	.service-card {
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		cursor: pointer;
		transition: all 0.3s;
	}

	.service-card:hover {
		border-color: #007bff;
		box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
	}

	.service-card.selected {
		border-color: #007bff;
		background: #e7f3ff;
	}

	.service-card-header {
		display: flex;
		align-items: center;
		margin-bottom: 10px;
	}

	.service-card-color {
		width: 20px;
		height: 20px;
		border-radius: 4px;
		margin-right: 10px;
	}

	.service-card-title {
		font-weight: 600;
		font-size: 16px;
	}

	.service-card-description {
		font-size: 14px;
		color: #666;
		margin-bottom: 10px;
	}

	.service-card-duration {
		font-size: 13px;
		color: #007bff;
		font-weight: 600;
		background: #e7f3ff;
		padding: 5px 10px;
		border-radius: 4px;
		display: inline-block;
		margin-top: 8px;
	}

	.location-options {
		display: flex;
		gap: 20px;
		margin-bottom: 30px;
	}

	.location-option {
		flex: 1;
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		cursor: pointer;
		text-align: center;
		transition: all 0.3s;
	}

	.location-option:hover {
		border-color: #007bff;
	}

	.location-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
	}

	.location-option-icon {
		font-size: 40px;
		margin-bottom: 10px;
	}

	.location-option-title {
		font-weight: 600;
		font-size: 16px;
	}

	.location-details {
		display: none;
		margin-top: 20px;
	}

	.location-details.show {
		display: block;
	}

	.date-time-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 30px;
		margin-top: 20px;
	}

	@media (max-width: 768px) {
		.date-time-container {
			grid-template-columns: 1fr;
		}
	}

	.date-picker-section,
	.time-picker-section {
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		background: #f8f9fa;
	}

	.section-title {
		font-weight: 600;
		font-size: 16px;
		margin-bottom: 15px;
		color: #333;
	}

	.date-input {
		width: 100%;
		padding: 12px;
		border: 2px solid #ddd;
		border-radius: 4px;
		font-size: 16px;
		background: white;
	}

	.date-input:focus {
		outline: none;
		border-color: #007bff;
	}

	.available-dates-list {
		max-height: 300px;
		overflow-y: auto;
		margin-top: 15px;
	}

	.date-option {
		padding: 12px 15px;
		margin-bottom: 8px;
		border: 2px solid #e0e0e0;
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.3s;
		background: white;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.date-option:hover {
		border-color: #007bff;
		background: #f0f8ff;
	}

	.date-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
		font-weight: 600;
	}

	.date-option-label {
		font-size: 14px;
	}

	.date-option-count {
		font-size: 12px;
		color: #666;
		background: #e0e0e0;
		padding: 3px 8px;
		border-radius: 12px;
	}

	.time-slots-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
		gap: 10px;
		max-height: 350px;
		overflow-y: auto;
	}

	.time-slot {
		border: 2px solid #e0e0e0;
		border-radius: 6px;
		padding: 12px 8px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s;
		background: white;
		font-size: 14px;
		font-weight: 500;
	}

	.time-slot:hover {
		border-color: #007bff;
		background: #f0f8ff;
		transform: translateY(-2px);
		box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
	}

	.time-slot.selected {
		border-color: #007bff;
		background: #007bff;
		color: white;
	}

	.no-selection-message {
		padding: 40px 20px;
		text-align: center;
		color: #999;
		font-style: italic;
	}

	.alert {
		padding: 15px;
		border-radius: 4px;
		margin-bottom: 20px;
	}

	.alert-success {
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.alert-danger {
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.step-content {
		display: none;
	}

	.step-content.active {
		display: block;
	}

	.appointment-type-options {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 20px;
		margin: 20px 0;
	}

	.appointment-type-option {
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		padding: 20px;
		cursor: pointer;
		text-align: center;
		transition: all 0.3s;
	}

	.appointment-type-option:hover {
		border-color: #007bff;
	}

	.appointment-type-option.selected {
		border-color: #007bff;
		background: #e7f3ff;
	}

	.appointment-type-option h4 {
		margin: 0 0 10px 0;
		color: #333;
	}

	@media (max-width: 768px) {
		.appointment-type-options {
			grid-template-columns: 1fr;
		}
	}
</style>

<div class="appointment-container">
	<h2 style="text-align: center; margin-bottom: 30px;">{{ _("Book an Appointment") }}</h2>

	<!-- Progress Bar -->
	<div class="progress-bar-container" id="progress-bar">
		<div class="progress-step" data-step="0">
			<div class="progress-step-circle">1</div>
			<div class="progress-step-label">{{ _("Company") }}</div>
		</div>
		<div class="progress-step" data-step="1">
			<div class="progress-step-circle">2</div>
			<div class="progress-step-label">{{ _("Information") }}</div>
		</div>
		<div class="progress-step" data-step="2">
			<div class="progress-step-circle">3</div>
			<div class="progress-step-label">{{ _("Services") }}</div>
		</div>
		<div class="progress-step" data-step="3">
			<div class="progress-step-circle">4</div>
			<div class="progress-step-label">{{ _("Location") }}</div>
		</div>
		<div class="progress-step" data-step="4">
			<div class="progress-step-circle">5</div>
			<div class="progress-step-label">{{ _("Date & Time") }}</div>
		</div>
		<div class="progress-step" data-step="5">
			<div class="progress-step-circle">‚úì</div>
			<div class="progress-step-label">{{ _("Success") }}</div>
		</div>
	</div>

	<!-- Step 0: Company Selection -->
	<div class="step-content active" id="step-0">
		<div class="form-section">
			<h3>{{ _("Select Company") }}</h3>

			<div class="appointment-type-options">
				<div class="appointment-type-option" onclick="selectCompany('Easy AI')">
					<h4>{{ _("Easy AI") }}</h4>
					<p>{{ _("Book an appointment with us") }}</p>
					<p style="margin-top: 10px; font-size: 14px; color: #666;">{{ _("Services: ERP-Loyalty - Website-APP
						- Host and Server Management") }}</p>
				</div>

				<div class="appointment-type-option" onclick="selectCompany('Directlines')">
					<h4>{{ _("Direct Line") }}</h4>
					<p>{{ _("Book an appointment with us") }}</p>
					<p style="margin-top: 10px; font-size: 14px; color: #666;">{{ _("Services: Photography - Videography
						- Production - Event Management") }}</p>
				</div>
			</div>
		</div>

		<div class="btn-container">
			<div></div>
			<button class="btn btn-primary" id="company-next-btn" onclick="proceedAfterCompanySelection()" disabled>{{
				_("Next") }}</button>
		</div>
	</div>

	<!-- Step 1: Customer Information -->
	<div class="step-content" id="step-1">
		<div class="form-section">
			<h3>{{ _("Customer Information") }}</h3>

			<div class="form-group">
				<label class="required">{{ _("Customer Name") }}</label>
				<input type="text" id="customer_name" class="form-control" required>
			</div>

			<div class="form-group">
				<label class="required">{{ _("Phone Number") }}</label>
				<input type="tel" id="phone_number" class="form-control" required>
			</div>

			<div class="form-group">
				<label class="required">{{ _("Email") }}</label>
				<input type="email" id="email" class="form-control" required>
			</div>
		</div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(0)">{{ _("Back") }}</button>
			<button class="btn btn-primary" onclick="goToStep(2)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 2: Services Selection -->
	<div class="step-content" id="step-2">
		<div class="form-section">
			<h3>{{ _("Select Services") }}</h3>
			<p>{{ _("Select one or more services you want") }}</p>

			<div class="services-grid" id="services-grid">
				<div style="padding: 20px; text-align: center;">{{ _("Loading services...") }}</div>
			</div>
		</div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(1)">{{ _("Back") }}</button>
			<button class="btn btn-primary" onclick="goToStep(3)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 3: Location Selection -->
	<div class="step-content" id="step-3">
		<div class="form-section">
			<h3>{{ _("Meeting Location") }}</h3>

			<div class="location-options">
				<div class="location-option" onclick="selectLocation('Our Location')">
					<div class="location-option-icon">üè¢</div>
					<div class="location-option-title">{{ _("Our Location") }}</div>
				</div>

				<div class="location-option" onclick="selectLocation('Customer Location')">
					<div class="location-option-icon">üè†</div>
					<div class="location-option-title">{{ _("Customer Location") }}</div>
				</div>
			</div>

			<!-- Company Location Display -->
			<div id="company-location-display" class="location-details">
				<div class="form-group">
					<label>{{ _("Our Location") }}</label>
					<div style="padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e0e0e0; line-height: 1.8;"
						id="company-location-text">
						{{ _("Loading...") }}
					</div>
				</div>
			</div>

			<!-- Customer Location Form -->
			<div id="customer-location-form" class="location-details">
				<div class="form-group">
					<label class="required">{{ _("Location") }}</label>
					<input type="text" id="location" class="form-control">
				</div>

				<div class="form-group">
					<label class="required">{{ _("Street Name") }}</label>
					<input type="text" id="street_name" class="form-control">
				</div>

				<div class="form-group">
					<label class="required">{{ _("Building Name and Number") }}</label>
					<input type="text" id="building_name" class="form-control">
				</div>

				<div class="form-group">
					<label class="required">{{ _("Apartment Number") }}</label>
					<input type="text" id="apartment_number" class="form-control">
				</div>
			</div>
		</div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(2)">{{ _("Back") }}</button>
			<button class="btn btn-primary" onclick="goToStep(4)">{{ _("Next") }}</button>
		</div>
	</div>

	<!-- Step 4: Date and Time Selection -->
	<div class="step-content" id="step-4">
		<div class="form-section">
			<h3>{{ _("Select Date and Time") }}</h3>

			<div class="date-time-container">
				<!-- Date Selection -->
				<div class="date-picker-section">
					<div class="section-title">üìÖ {{ _("1. Select a Date") }}</div>
					<div id="available-dates-container">
						<div style="padding: 20px; text-align: center;">{{ _("Loading available dates...") }}</div>
					</div>
				</div>

				<!-- Time Selection -->
				<div class="time-picker-section">
					<div class="section-title">‚è∞ {{ _("2. Select a Time") }}</div>
					<div id="time-slots-container">
						<div class="no-selection-message">
							{{ _("Please select a date first") }}
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="alert-message" style="display: none;"></div>

		<div class="btn-container">
			<button class="btn btn-secondary" onclick="goToStep(3)">{{ _("Back") }}</button>
			<button class="btn btn-primary" id="submit-btn" onclick="submitBooking()">{{ _("Book Appointment")
				}}</button>
		</div>
	</div>
</div>

<script>
	// App state
	const appState = {
		currentStep: 0,
		company: '',
		customerName: '',
		phoneNumber: '',
		email: '',
		selectedServices: [],
		meetingLocation: '',
		location: '',
		streetName: '',
		buildingName: '',
		apartmentNumber: '',
		bookingDate: '',
		bookingTime: '',
		bookingTimeTo: '',
		services: [],
		companyLocation: '',
		availableSlots: [],
		selectedDate: null,
		slotsByDate: {}
	};

	// Initialize on page load
	document.addEventListener('DOMContentLoaded', function () {
		console.log('Page loaded, initializing...');
		loadServices();
		loadCompanyLocation();
		loadTimeSlots();
		updateProgressBar();
		console.log('Initialization complete');
	});

	// Navigation
	function goToStep(step) {
		// Validate current step before moving forward (skip validation for step 0)
		if (step > appState.currentStep && step > 0 && !validateCurrentStep()) {
			return;
		}

		// Save current step data
		if (appState.currentStep > 0) {
			saveStepData(appState.currentStep);
		}

		// Hide all steps
		document.querySelectorAll('.step-content').forEach(el => {
			el.classList.remove('active');
		});

		// Show target step
		const targetStep = document.getElementById('step-' + step);
		if (targetStep) {
			targetStep.classList.add('active');
			appState.currentStep = step;

			// Update progress bar
			updateProgressBar();

			// Scroll to top
			window.scrollTo(0, 0);
		}
	}

	function updateProgressBar() {
		const steps = document.querySelectorAll('.progress-step');
		steps.forEach((step, index) => {
			const stepNum = parseInt(step.getAttribute('data-step'));
			step.classList.remove('active', 'completed');

			if (stepNum < appState.currentStep) {
				step.classList.add('completed');
			} else if (stepNum === appState.currentStep) {
				step.classList.add('active');
			}
		});
	}

	function selectCompany(company) {
		appState.company = company;

		// Update visual selection
		document.querySelectorAll('.appointment-type-option').forEach(opt => {
			opt.classList.remove('selected');
		});
		event.currentTarget.classList.add('selected');

		// Load company location when company is selected
		if (company === 'Easy AI') {
			loadCompanyLocation();
		}

		// Enable next button
		document.getElementById('company-next-btn').disabled = false;
	}

	function proceedAfterCompanySelection() {
		if (!appState.company) {
			alert('{{ _("Please select a company") }}');
			return;
		}

		// If Direct Line, redirect to video-production-appointment page
		if (appState.company === 'Direct Line' || appState.company === 'Directlines') {
			window.location.href = '/video-production-appointment';
			return;
		}

		// If Easy AI, continue to next step
		goToStep(1);
	}

	function validateCurrentStep() {
		const step = appState.currentStep;

		if (step === 0) {
			if (!appState.company) {
				alert('{{ _("Please select a company") }}');
				return false;
			}
		}

		if (step === 1) {
			const name = document.getElementById('customer_name').value.trim();
			const phone = document.getElementById('phone_number').value.trim();
			const email = document.getElementById('email').value.trim();

			if (!name || !phone || !email) {
				alert('{{ _("Please fill in all required fields") }}');
				return false;
			}

			if (!email.includes('@')) {
				alert('{{ _("Please enter a valid email address") }}');
				return false;
			}
		}

		if (step === 2) {
			if (appState.selectedServices.length === 0) {
				alert('{{ _("Please select at least one service") }}');
				return false;
			}
		}

		if (step === 3) {
			if (!appState.meetingLocation) {
				alert('{{ _("Please select a meeting location") }}');
				return false;
			}

			if (appState.meetingLocation === 'Customer Location') {
				const loc = document.getElementById('location').value.trim();
				const street = document.getElementById('street_name').value.trim();
				const building = document.getElementById('building_name').value.trim();
				const apt = document.getElementById('apartment_number').value.trim();

				if (!loc || !street || !building || !apt) {
					alert('{{ _("Please fill in all location details") }}');
					return false;
				}
			}
		}

		if (step === 4) {
			if (!appState.bookingDate || !appState.bookingTime) {
				alert('{{ _("Please select a date and time") }}');
				return false;
			}
		}

		return true;
	}

	function saveStepData(step) {
		if (step === 0) {
			// Company is already saved in appState.company
		}

		if (step === 1) {
			appState.customerName = document.getElementById('customer_name').value;
			appState.phoneNumber = document.getElementById('phone_number').value;
			appState.email = document.getElementById('email').value;
		}

		if (step === 3) {
			if (appState.meetingLocation === 'Customer Location') {
				appState.location = document.getElementById('location').value;
				appState.streetName = document.getElementById('street_name').value;
				appState.buildingName = document.getElementById('building_name').value;
				appState.apartmentNumber = document.getElementById('apartment_number').value;
			}
		}
	}

	// Load Services
	function loadServices() {
		frappe.call({
			method: 'appointment_addons.www.book-appointment.get_services',
			callback: function (r) {
				if (r.message) {
					appState.services = r.message;
					renderServices();
				}
			}
		});
	}

	function renderServices() {
		const grid = document.getElementById('services-grid');

		if (appState.services.length === 0) {
			grid.innerHTML = '<div class="alert alert-danger">{{ _("No services available at the moment. Please contact the administrator.") }}</div>';
			return;
		}

		grid.innerHTML = '';
		appState.services.forEach(service => {
			const card = document.createElement('div');
			card.className = 'service-card';
			card.onclick = () => toggleService(service.name);

			card.innerHTML = `
			<div class="service-card-header">
				<div class="service-card-color" style="background: ${service.color || '#007bff'};"></div>
				<div class="service-card-title">${service.service_name}</div>
			</div>
			${service.description ? `<div class="service-card-description">${service.description}</div>` : ''}
			<div class="service-card-duration">‚è±Ô∏è ${service.duration} {{ _("minutes") }}</div>
		`;

			if (appState.selectedServices.includes(service.name)) {
				card.classList.add('selected');
			}

			grid.appendChild(card);
		});
	}

	function toggleService(serviceName) {
		const index = appState.selectedServices.indexOf(serviceName);
		if (index > -1) {
			appState.selectedServices.splice(index, 1);
		} else {
			appState.selectedServices.push(serviceName);
		}
		renderServices();
	}

	// Load Company Location
	function loadCompanyLocation() {
		frappe.call({
			method: 'appointment_addons.www.book-appointment.get_company_location',
			callback: function (r) {
				const locationText = document.getElementById('company-location-text');
				if (locationText) {
					if (appState.company === 'Easy AI') {
						// Show Easy AI specific location
						appState.companyLocation = 'Qatar - Doha - C Ring - Bin Mahmoud area\nAl mana tower B\nMezzanine floor\nOffice no 12\n\nhttps://www.google.com/maps?q=25.2773603,51.5086372&z=17&hl=en';
						locationText.innerHTML = `Qatar - Doha - C Ring - Bin Mahmoud area<br>
						Direct line<br>
						Al mana tower B<br>
						Mezzanine floor<br>
						Office no 12<br><br>
						<a href="https://www.google.com/maps?q=25.2773603,51.5086372&z=17&hl=en" target="_blank" style="color: #007bff;">https://www.google.com/maps?q=25.2773603,51.5086372&z=17&hl=en</a>`;
					} else if (r.message) {
						appState.companyLocation = r.message;
						locationText.textContent = r.message || '{{ _("Location not set. Please contact administrator.") }}';
					}
				}
			}
		});
	}

	// Location Selection
	function selectLocation(locationType) {
		appState.meetingLocation = locationType;

		// Update visual selection
		document.querySelectorAll('.location-option').forEach(opt => {
			opt.classList.remove('selected');
		});
		event.currentTarget.classList.add('selected');

		// Show/hide location details
		const companyDisplay = document.getElementById('company-location-display');
		const customerForm = document.getElementById('customer-location-form');

		if (locationType === 'Our Location') {
			companyDisplay.classList.add('show');
			customerForm.classList.remove('show');
		} else {
			companyDisplay.classList.remove('show');
			customerForm.classList.add('show');
		}
	}

	// Load Time Slots
	function loadTimeSlots() {
		frappe.call({
			method: 'appointment_addons.www.book-appointment.get_time_slots',
			callback: function (r) {
				console.log('Time slots response:', r);
				if (r.message) {
					console.log('Time slots received:', r.message);
					appState.availableSlots = r.message;
					groupSlotsByDate();
					renderAvailableDates();
				} else {
					console.error('No time slots received');
					const container = document.getElementById('available-dates-container');
					if (container) {
						container.innerHTML = '<div class="alert alert-danger">No available dates. Please check Appointment Booking Settings.</div>';
					}
				}
			},
			error: function (r) {
				console.error('Error loading time slots:', r);
				const container = document.getElementById('available-dates-container');
				if (container) {
					container.innerHTML = '<div class="alert alert-danger">Error loading time slots. Please try again.</div>';
				}
			}
		});
	}

	function groupSlotsByDate() {
		appState.slotsByDate = {};

		console.log('Grouping slots:', appState.availableSlots);

		if (!appState.availableSlots || appState.availableSlots.length === 0) {
			console.warn('No available slots to group');
			return;
		}

		appState.availableSlots.forEach(slot => {
			if (!appState.slotsByDate[slot.date]) {
				appState.slotsByDate[slot.date] = {
					date: slot.date,
					date_display: slot.date_display,
					day: slot.day,
					slots: []
				};
			}
			appState.slotsByDate[slot.date].slots.push(slot);
		});

		console.log('Grouped slots by date:', appState.slotsByDate);
	}

	function renderAvailableDates() {
		const container = document.getElementById('available-dates-container');
		const dates = Object.values(appState.slotsByDate);

		console.log('Rendering dates:', dates);

		if (dates.length === 0) {
			console.warn('No dates to render');
			container.innerHTML = '<div class="alert alert-danger">{{ _("No available dates at the moment. Please check Appointment Booking Settings and ensure availability slots are configured.") }}</div>';
			return;
		}

		container.innerHTML = '<div class="available-dates-list"></div>';
		const list = container.querySelector('.available-dates-list');

		dates.forEach(dateInfo => {
			const dateEl = document.createElement('div');
			dateEl.className = 'date-option';
			if (appState.selectedDate === dateInfo.date) {
				dateEl.classList.add('selected');
			}

			dateEl.onclick = () => selectDate(dateInfo.date);

			const slotsCount = dateInfo.slots.length;
			const slotText = slotsCount === 1 ? '{{ _("slot") }}' : '{{ _("slots") }}';

			dateEl.innerHTML = `
			<div>
				<div class="date-option-label">${dateInfo.date_display}</div>
				<div style="font-size: 12px; color: #666; margin-top: 2px;">${dateInfo.day}</div>
			</div>
			<div class="date-option-count">${slotsCount} ${slotText}</div>
		`;

			list.appendChild(dateEl);
		});
	}

	function selectDate(date) {
		appState.selectedDate = date;
		appState.bookingDate = date;
		appState.bookingTime = ''; // Reset time selection

		renderAvailableDates();
		renderTimeSlotsForDate(date);
	}

	function renderTimeSlotsForDate(date) {
		const container = document.getElementById('time-slots-container');
		const dateInfo = appState.slotsByDate[date];

		if (!dateInfo || dateInfo.slots.length === 0) {
			container.innerHTML = '<div class="no-selection-message">{{ _("No available times for this date") }}</div>';
			return;
		}

		container.innerHTML = '<div class="time-slots-grid"></div>';
		const grid = container.querySelector('.time-slots-grid');

		dateInfo.slots.forEach(slot => {
			const timeEl = document.createElement('div');
			timeEl.className = 'time-slot';
			if (appState.bookingTime === slot.from_time) {
				timeEl.classList.add('selected');
			}

			timeEl.onclick = () => selectTimeSlot(slot.from_time, slot.to_time);

			// Display time range if to_time is available, otherwise just from_time
			const timeDisplay = slot.to_time ? `${slot.from_time} : ${slot.to_time}` : `${slot.from_time}`;
			timeEl.innerHTML = timeDisplay;

			grid.appendChild(timeEl);
		});
	}

	function selectTimeSlot(time, toTime) {
		appState.bookingTime = time;
		appState.bookingTimeTo = toTime || '';
		renderTimeSlotsForDate(appState.selectedDate);
	}

	// Submit Booking
	function submitBooking() {
		if (!validateCurrentStep()) {
			return;
		}

		const submitBtn = document.getElementById('submit-btn');
		const alertDiv = document.getElementById('alert-message');

		// Disable submit button
		submitBtn.disabled = true;
		submitBtn.textContent = '{{ _("Booking...") }}';

		// Prepare data
		const data = {
			company: appState.company || 'Easy AI',
			customer_name: appState.customerName,
			phone_number: appState.phoneNumber,
			email: appState.email,
			selected_services: JSON.stringify(appState.selectedServices),
			meeting_location: appState.meetingLocation,
			location: appState.location,
			street_name: appState.streetName,
			building_name: appState.buildingName,
			apartment_number: appState.apartmentNumber,
			booking_date: appState.bookingDate,
			booking_time: appState.bookingTime
		};

		frappe.call({
			method: 'appointment_addons.www.book-appointment.create_appointment',
			args: {
				data: JSON.stringify(data)
			},
			callback: function (r) {
				if (r.message && r.message.success) {
					// Show success page
					goToStep(5);
				} else {
					alertDiv.className = 'alert alert-danger';
					alertDiv.textContent = r.message ? r.message.message : '{{ _("An error occurred. Please try again.") }}';
					alertDiv.style.display = 'block';
					submitBtn.disabled = false;
					submitBtn.textContent = '{{ _("Book Appointment") }}';
				}
			},
			error: function () {
				alertDiv.className = 'alert alert-danger';
				alertDiv.textContent = '{{ _("Network error. Please check your connection and try again.") }}';
				alertDiv.style.display = 'block';
				submitBtn.disabled = false;
				submitBtn.textContent = '{{ _("Book Appointment") }}';
			}
		});
	}
</script>

{% endblock %}